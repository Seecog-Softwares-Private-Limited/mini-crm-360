<div class="container-fluid">
  <div class="row">
    {{> sidebar}}

    <div class="col-md-9 col-lg-10 main-content">
      <div class="container-fluid p-4">
        <style>
          /* ============================================
             WORLD-CLASS PREMIUM REMINDERS PAGE STYLING
             ============================================ */
          
          /* Page Background */
          .main-content {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            position: relative;
          }

          /* Sticky sidebar + scrollable content */
          .container-fluid > .row {
            height: 100vh;
            overflow: hidden;
          }
          .row > .col-md-3.col-lg-2 {
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
          }
          .row > .col-md-9.col-lg-10.main-content {
            height: 100vh;
            overflow-y: auto;
            padding-bottom: 2rem;
          }

          .main-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
              radial-gradient(circle at 20% 50%, rgba(102, 126, 234, 0.05) 0%, transparent 50%),
              radial-gradient(circle at 80% 80%, rgba(118, 75, 162, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
          }

          .container-fluid.p-4 {
            position: relative;
          }

          /* Page Header - Same as business page */
          .page-header {
            margin-bottom: 2rem;
          }

          .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: #1e293b;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
          }

          .page-title::before {
            content: '';
            width: 4px;
            height: 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
          }

          .page-subtitle {
            color: #64748b;
            font-size: 0.95rem;
            margin-top: 0.5rem;
          }

          /* Filter Tabs */
          .filter-tabs {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            background: white;
            padding: 0.5rem;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
          }

          .filter-tab {
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #64748b;
            background: transparent;
            border: 2px solid transparent;
          }

          .filter-tab:hover {
            background: #f1f5f9;
            color: #475569;
          }

          .filter-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
          }

          /* Table + bulk actions */
          .reminders-table-container {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
            padding: 1rem;
            position: relative;
          }
          .bulk-action-bar {
            display: none;
            position: sticky;
            top: 0;
            z-index: 10;
            background: #fff;
            border-radius: 12px;
            padding: 0.75rem 1rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08), 0 0 0 1px rgba(0,0,0,0.04);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 0.5rem;
          }
          .bulk-action-buttons button {
            border: none;
            border-radius: 10px;
            padding: 0.55rem 1rem;
            font-weight: 600;
            color: #fff;
            transition: all 0.2s ease;
          }
          .bulk-action-buttons .whatsapp-btn { background: linear-gradient(135deg,#25d366,#128c7e); }
          .bulk-action-buttons .email-btn { background: linear-gradient(135deg,#667eea,#764ba2); }
          .bulk-action-buttons .clear-btn { background: #e2e8f0; color: #475569; }
          .reminders-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
          }
          .reminders-table th, .reminders-table td {
            padding: 0.75rem;
            vertical-align: middle;
          }
          .reminders-table thead th {
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 700;
            color: #475569;
          }
          .reminders-table tbody tr:hover {
            background: #f8fafc;
          }
          .checkbox-col { width: 48px; text-align: center; }
          .reminder-type-badge {
            padding: 0.35rem 0.8rem;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.8rem;
          }
          .reminder-type-badge.birthday { background: #fce7f3; color: #db2777; }
          .reminder-type-badge.anniversary { background: #fef3c7; color: #d97706; }
          .reminder-actions .btn {
            margin-right: 0.35rem;
            margin-bottom: 0.25rem;
          }
          .reminders-pagination-wrapper {
            display: none;
            margin-top: 1rem;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 0.75rem;
          }
          .pagination-buttons button {
            border: 1px solid #e2e8f0;
            background: #fff;
            border-radius: 8px;
            padding: 0.4rem 0.75rem;
          }
          .pagination-info { font-weight: 600; color: #475569; }

          /* Reminders List */
          .reminders-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
          }

          .reminder-item {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 
              0 4px 12px rgba(0, 0, 0, 0.08),
              0 0 0 1px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            border-left: 5px solid;
            position: relative;
            overflow: hidden;
          }

          .reminder-item:hover {
            transform: translateX(4px);
            box-shadow: 
              0 8px 20px rgba(0, 0, 0, 0.12),
              0 0 0 1px rgba(0, 0, 0, 0.05);
          }

          .reminder-item.birthday {
            border-left-color: #ec4899;
            background: linear-gradient(135deg, #ffffff 0%, #fdf2f8 100%);
          }

          .reminder-item.anniversary {
            border-left-color: #f59e0b;
            background: linear-gradient(135deg, #ffffff 0%, #fffbeb 100%);
          }

          .reminder-item.today {
            border-left-color: #10b981;
            animation: pulse-border 2s infinite;
          }

          @keyframes pulse-border {
            0%, 100% { border-left-width: 5px; }
            50% { border-left-width: 8px; }
          }

          .reminder-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
          }

          .reminder-info {
            flex: 1;
          }

          .reminder-customer-name {
            font-weight: 700;
            font-size: 1.25rem;
            color: #1f2937;
            margin-bottom: 0.25rem;
          }

          .reminder-type-badge {
            display: inline-block;
            padding: 0.375rem 0.875rem;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.5rem;
          }

          .reminder-type-badge.birthday {
            background: #fce7f3;
            color: #db2777;
          }

          .reminder-type-badge.anniversary {
            background: #fef3c7;
            color: #d97706;
          }

          .reminder-date-info {
            text-align: right;
          }

          .reminder-days-until {
            font-size: 2rem;
            font-weight: 800;
            color: #667eea;
            line-height: 1;
            margin-bottom: 0.25rem;
          }

          .reminder-days-until.today {
            color: #10b981;
            animation: pulse-text 2s infinite;
          }

          @keyframes pulse-text {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
          }

          .reminder-date-label {
            font-size: 0.75rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
          }

          .reminder-date-value {
            font-size: 0.9rem;
            color: #4b5563;
            margin-top: 0.25rem;
          }

          .reminder-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
          }

          .reminder-action-btn {
            padding: 0.625rem 1.25rem;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.875rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
          }

          .reminder-action-btn.whatsapp {
            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
          }

          .reminder-action-btn.whatsapp:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 211, 102, 0.4);
          }

          .reminder-action-btn.email {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
          }

          .reminder-action-btn.email:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
          }

          .reminder-action-btn.edit {
            background: #f3f4f6;
            color: #64748b;
            border: 2px solid #e5e7eb;
          }

          .reminder-action-btn.edit:hover {
            background: #e5e7eb;
            color: #475569;
          }

          /* Empty State */
          .reminders-empty {
            text-align: center;
            padding: 4rem 2rem;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
          }

          .reminders-empty i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
            color: #9ca3af;
          }

          /* Premium Modal */
          .premium-modal {
            z-index: 1055 !important;
          }

          .premium-modal .modal-dialog {
            z-index: 1056 !important;
            pointer-events: auto !important;
            margin: 1.75rem auto;
            animation: modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
          }

          @keyframes modalSlideIn {
            from {
              opacity: 0;
              transform: translateY(-50px) scale(0.95);
            }
            to {
              opacity: 1;
              transform: translateY(0) scale(1);
            }
          }

          .premium-modal .modal-content {
            border-radius: 28px;
            overflow: hidden;
            border: none;
            box-shadow: 
              0 40px 100px rgba(0, 0, 0, 0.5),
              0 0 0 1px rgba(255, 255, 255, 0.15) inset,
              0 20px 60px rgba(102, 126, 234, 0.3);
            pointer-events: auto !important;
            position: relative;
            z-index: 1057 !important;
            background: #ffffff;
            backdrop-filter: blur(20px);
          }

          .premium-modal .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, 
              #667eea 0%, 
              #764ba2 25%, 
              #f093fb 50%, 
              #4facfe 75%, 
              #667eea 100%);
            background-size: 200% 100%;
            animation: gradientShift 3s ease infinite;
          }

          @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
          }

          .premium-modal .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 200% 200%;
            animation: gradientMove 8s ease infinite;
            color: white;
            padding: 3rem 3rem 2.5rem;
            border-bottom: none;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
          }

          @keyframes gradientMove {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
          }

          .premium-modal .modal-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.2) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
            pointer-events: none;
          }

          .premium-modal .modal-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, 
              transparent 0%, 
              rgba(255, 255, 255, 0.3) 50%, 
              transparent 100%);
          }

          .premium-modal .modal-title {
            font-weight: 800;
            font-size: 2rem;
            position: relative;
            z-index: 1;
            letter-spacing: -0.8px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 0.75rem;
          }

          .premium-modal .modal-title i {
            font-size: 1.5rem;
            opacity: 0.95;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
          }

          .premium-modal .btn-close {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border-radius: 50%;
            opacity: 1;
            padding: 0.75rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 2;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
          }

          .premium-modal .btn-close:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: rotate(90deg) scale(1.1);
            border-color: rgba(255, 255, 255, 0.5);
          }

          .premium-modal .modal-body {
            padding: 3rem;
            background: linear-gradient(135deg, #fafbfc 0%, #ffffff 50%, #f8fafc 100%);
            position: relative;
            overflow: hidden;
          }

          .premium-modal .modal-body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, 
              transparent 0%, 
              rgba(102, 126, 234, 0.1) 50%, 
              transparent 100%);
          }

          .premium-modal .form-label {
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 0.875rem;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            position: relative;
            padding-left: 0.5rem;
          }

          .premium-modal .form-label::before {
            content: '';
            width: 5px;
            height: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 3px;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
            flex-shrink: 0;
          }

          .premium-modal .form-control {
            border-radius: 14px;
            border: 2px solid #e2e8f0;
            padding: 1rem 1.5rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.95rem;
            background: #ffffff;
            box-shadow: 
              0 2px 8px rgba(0, 0, 0, 0.04),
              0 0 0 0 rgba(102, 126, 234, 0);
            color: #1e293b;
            font-weight: 500;
          }

          .premium-modal .form-control:hover {
            border-color: #cbd5e1;
            box-shadow: 
              0 4px 16px rgba(0, 0, 0, 0.08),
              0 0 0 2px rgba(102, 126, 234, 0.05);
            transform: translateY(-1px);
            background: #fefefe;
          }

          .premium-modal .form-control:focus {
            border-color: #667eea;
            box-shadow: 
              0 0 0 4px rgba(102, 126, 234, 0.12),
              0 6px 20px rgba(102, 126, 234, 0.2),
              0 2px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
            outline: none;
            background: #ffffff;
          }

          .premium-modal .form-control::placeholder {
            color: #94a3b8;
            font-style: italic;
            font-weight: 400;
            opacity: 0.8;
          }

          .premium-modal .form-select {
            border-radius: 14px;
            border: 2px solid #e2e8f0;
            padding: 1rem 1.5rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.95rem;
            background: #ffffff;
            box-shadow: 
              0 2px 8px rgba(0, 0, 0, 0.04),
              0 0 0 0 rgba(102, 126, 234, 0);
            color: #1e293b;
            font-weight: 500;
            cursor: pointer;
          }

          .premium-modal .form-select:hover {
            border-color: #cbd5e1;
            box-shadow: 
              0 4px 16px rgba(0, 0, 0, 0.08),
              0 0 0 2px rgba(102, 126, 234, 0.05);
            transform: translateY(-1px);
          }

          .premium-modal .form-select:focus {
            border-color: #667eea;
            box-shadow: 
              0 0 0 4px rgba(102, 126, 234, 0.12),
              0 6px 20px rgba(102, 126, 234, 0.2),
              0 2px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
            outline: none;
          }

          .premium-modal .modal-footer {
            border-top: 1px solid #e2e8f0;
            padding: 2.5rem 3rem;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 50%, #f1f5f9 100%);
            position: relative;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
          }

          .premium-modal .modal-footer::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, 
              transparent 0%, 
              rgba(102, 126, 234, 0.1) 50%, 
              transparent 100%);
          }

          .premium-modal .btn {
            border-radius: 14px;
            padding: 1rem 2.75rem;
            font-weight: 700;
            font-size: 0.95rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
          }

          .premium-modal .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 200% 200%;
            animation: gradientMove 3s ease infinite;
            color: white;
            box-shadow: 
              0 6px 20px rgba(102, 126, 234, 0.4),
              0 2px 8px rgba(102, 126, 234, 0.3),
              inset 0 1px 0 rgba(255, 255, 255, 0.2);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1;
          }

          .premium-modal .btn-primary:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 
              0 12px 35px rgba(102, 126, 234, 0.5),
              0 4px 12px rgba(102, 126, 234, 0.4),
              0 0 0 4px rgba(102, 126, 234, 0.15),
              inset 0 1px 0 rgba(255, 255, 255, 0.3);
            background-position: 100% 50%;
          }

          .premium-modal .btn-secondary {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 2px solid #e2e8f0;
            color: #64748b;
            box-shadow: 
              0 2px 8px rgba(0, 0, 0, 0.05),
              inset 0 1px 0 rgba(255, 255, 255, 0.8);
            font-weight: 600;
          }

          .premium-modal .btn-secondary:hover {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-color: #cbd5e1;
            transform: translateY(-2px);
            color: #475569;
          }

          /* Ensure all form elements are clickable */
          .premium-modal input,
          .premium-modal select,
          .premium-modal textarea,
          .premium-modal button,
          .premium-modal .btn-close {
            pointer-events: auto !important;
            cursor: pointer;
          }

          .premium-modal input[type="text"],
          .premium-modal input[type="date"],
          .premium-modal textarea {
            cursor: text !important;
          }

          body.modal-open {
            overflow: hidden;
            padding-right: 0 !important;
          }

          .modal-backdrop {
            z-index: 1050 !important;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
          }

          /* Premium Notification System */
          .premium-notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-width: 400px;
            pointer-events: none;
          }

          .premium-notification {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 16px;
            padding: 1.25rem 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(226, 232, 240, 0.8);
            pointer-events: auto;
            animation: slideInRight 0.3s ease-out;
            min-width: 320px;
          }

          .premium-notification.success {
            border-left: 4px solid #10b981;
          }

          .premium-notification.error {
            border-left: 4px solid #ef4444;
          }

          .premium-notification.warning {
            border-left: 4px solid #f59e0b;
          }

          .premium-notification.info {
            border-left: 4px solid #3b82f6;
          }

          .notification-icon-wrapper {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
          }

          .premium-notification.success .notification-icon-wrapper {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%);
            color: #10b981;
          }

          .premium-notification.error .notification-icon-wrapper {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%);
            color: #ef4444;
          }

          .premium-notification.warning .notification-icon-wrapper {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(217, 119, 6, 0.1) 100%);
            color: #f59e0b;
          }

          .premium-notification.info .notification-icon-wrapper {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.1) 100%);
            color: #3b82f6;
          }

          .notification-icon-wrapper i {
            font-size: 1.25rem;
          }

          .notification-content {
            flex: 1;
            min-width: 0;
          }

          .notification-title {
            font-weight: 700;
            font-size: 1rem;
            color: #1e293b;
            margin-bottom: 0.25rem;
            line-height: 1.4;
          }

          .notification-message {
            font-size: 0.875rem;
            color: #64748b;
            line-height: 1.5;
            margin-top: 0.25rem;
          }

          .notification-close {
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 6px;
            transition: all 0.2s ease;
            flex-shrink: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
          }

          .notification-close:hover {
            background: rgba(148, 163, 184, 0.1);
            color: #64748b;
          }

          .notification-progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 100%;
            animation: progressBar 5s linear forwards;
          }

          @keyframes progressBar {
            from {
              width: 100%;
            }
            to {
              width: 0%;
            }
          }

          .notification-stats {
            display: flex;
            gap: 1rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(226, 232, 240, 0.8);
          }

          .notification-stat-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
          }

          .notification-stat-label {
            font-size: 0.75rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
          }

          .notification-stat-value {
            font-size: 1.125rem;
            font-weight: 700;
            color: #1e293b;
          }

          .notification-stat-value.success {
            color: #10b981;
          }

          .notification-stat-value.error {
            color: #ef4444;
          }

          /* Button Loader Styles */
          #sendWishBtn {
            position: relative;
            min-width: 140px;
          }

          #sendWishBtn .btn-text,
          #sendWishBtn .btn-loader {
            display: inline-flex;
            align-items: center;
            justify-content: center;
          }

          #sendWishBtn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
          }

          #sendWishBtn .spinner-border-sm {
            width: 1rem;
            height: 1rem;
            border-width: 0.15em;
          }
        </style>

        <!-- Page Header -->
        <div class="page-header">
          <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
            <div>
              <h1 class="page-title">Birthday & Anniversary Reminders</h1>
              <p class="page-subtitle">Never miss a special occasion - send wishes automatically</p>
            </div>
          </div>
        </div>

        <!-- Filter Tabs -->
        <div class="filter-tabs">
          <div class="filter-tab active" onclick="filterReminders('all')" data-filter="all">All</div>
          <div class="filter-tab" onclick="filterReminders('today')" data-filter="today">Today</div>
          <div class="filter-tab" onclick="filterReminders('birthday')" data-filter="birthday">Birthdays</div>
          <div class="filter-tab" onclick="filterReminders('anniversary')" data-filter="anniversary">Anniversaries</div>
          <div class="filter-tab" onclick="filterReminders('upcoming')" data-filter="upcoming">Upcoming (7 days)</div>
        </div>

        <!-- Bulk Action Bar -->
        <div class="bulk-action-bar" id="bulkActionBar">
          <div class="d-flex align-items-center gap-2">
            <span id="bulkSelectedCount">0</span> selected
          </div>
          <div class="bulk-action-buttons d-flex align-items-center gap-2">
            <button class="whatsapp-btn" onclick="openBulkSendModal('whatsapp')" id="bulkWhatsAppBtn"><i class="fab fa-whatsapp me-1"></i>Send WhatsApp</button>
            <button class="email-btn" onclick="openBulkSendModal('email')" id="bulkEmailBtn"><i class="fas fa-envelope me-1"></i>Send Email</button>
            <button class="clear-btn" onclick="clearSelection()"><i class="fas fa-times me-1"></i>Clear</button>
          </div>
        </div>

        <!-- Reminders Table -->
        <div class="reminders-table-container" id="remindersList">
          <div class="text-center p-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-3 text-muted">Loading reminders...</p>
          </div>
        </div>

        <!-- Pagination -->
        <div class="reminders-pagination-wrapper" id="remindersPagination">
          <div class="pagination-buttons">
            <button id="firstPageBtn" onclick="goToPage(1)"><i class="fas fa-angle-double-left"></i></button>
            <button id="prevPageBtn" onclick="changePage(-1)"><i class="fas fa-chevron-left"></i></button>
            <span class="pagination-info" id="paginationInfo">Page 1 of 1</span>
            <button id="nextPageBtn" onclick="changePage(1)"><i class="fas fa-chevron-right"></i></button>
            <button id="lastPageBtn" onclick="goToPage(-1)"><i class="fas fa-angle-double-right"></i></button>
          </div>
          <div class="pagination-info" id="paginationTotal">Showing 0</div>
        </div>

        <!-- Edit Date Modal -->
        <div class="modal fade premium-modal" id="editDateModal" tabindex="-1" aria-labelledby="editDateModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="editDateModalLabel">
                  <i class="fas fa-calendar-alt me-2"></i>Edit Date
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <form id="editDateForm">
                  <input type="hidden" id="editCustomerId" name="customerId">
                  <div class="mb-3">
                    <label for="editDateOfBirth" class="form-label">Date of Birth</label>
                    <input type="date" class="form-control" id="editDateOfBirth" name="dateOfBirth">
                  </div>
                  <div class="mb-3">
                    <label for="editAnniversaryDate" class="form-label">Anniversary Date</label>
                    <input type="date" class="form-control" id="editAnniversaryDate" name="anniversaryDate">
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveDate()">
                  <i class="fas fa-save me-2"></i>Save
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Send Wish Modal -->
        <div class="modal fade premium-modal" id="sendWishModal" tabindex="-1" aria-labelledby="sendWishModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="sendWishModalLabel">
                  <i class="fas fa-paper-plane me-2"></i>Send Wish
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <form id="sendWishForm">
                  <input type="hidden" id="wishCustomerId" name="customerId">
                  <input type="hidden" id="wishType" name="type">
                  
                  <div class="mb-3">
                    <label for="wishChannel" class="form-label">Channel *</label>
                    <select class="form-select" id="wishChannel" name="channel" required onchange="loadTemplates()">
                      <option value="">Select Channel</option>
                      <option value="whatsapp">WhatsApp</option>
                      <option value="email">Email</option>
                    </select>
                  </div>

                  <div class="mb-3" id="whatsappTemplateGroup" style="display: none;">
                    <label for="whatsappTemplate" class="form-label">WhatsApp Template</label>
                    <select class="form-select" id="whatsappTemplate" name="templateId">
                      <option value="">Select Template (Optional)</option>
                    </select>
                  </div>

                  <div class="mb-3" id="emailTemplateGroup" style="display: none;">
                    <label for="emailTemplate" class="form-label">Email Template</label>
                    <select class="form-select" id="emailTemplate" name="emailTemplateId">
                      <option value="">Select Template (Optional)</option>
                    </select>
                  </div>

                  <div class="mb-3" id="customMessageGroup" style="display: none;">
                    <label for="customMessage" class="form-label">Custom Message</label>
                    <textarea class="form-control" id="customMessage" name="customMessage" rows="4" placeholder="Enter your custom message (if not using template)..."></textarea>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="sendWishBtn" onclick="sendWish()">
                  <span class="btn-text">
                    <i class="fas fa-paper-plane me-2"></i>Send Wish
                  </span>
                  <span class="btn-loader" style="display: none;">
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Sending...
                  </span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Bulk Send Modal -->
        <div class="modal fade premium-modal" id="bulkSendModal" tabindex="-1" aria-labelledby="bulkSendModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="bulkSendModalLabel"><i class="fas fa-paper-plane me-2"></i>Bulk Send</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <input type="hidden" id="bulkChannel">
                <div class="mb-3">
                  <strong id="bulkSummary">0 selected</strong>
                  <div id="bulkCounts" class="text-muted small"></div>
                  <div id="bulkSkippedList" class="text-danger small mt-1"></div>
                </div>
                <div class="mb-3" id="bulkTemplateGroup">
                  <label class="form-label">Template (optional)</label>
                  <select class="form-select" id="bulkTemplate">
                    <option value="">No Template</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Message</label>
                  <textarea id="bulkMessage" class="form-control" rows="5" placeholder="Use {{customer_name}} and {{company_name}}"></textarea>
                </div>
                <div class="mb-2 fw-semibold">Preview</div>
                <div class="border rounded p-3 bg-light" id="bulkPreview">Enter a message to see preview</div>
                <div class="d-flex justify-content-between align-items-center mt-2">
                  <button class="btn btn-outline-secondary btn-sm" id="prevPreviewBtn" onclick="changeBulkPreview(-1)">Prev</button>
                  <span id="previewCounter">0 / 0</span>
                  <button class="btn btn-outline-secondary btn-sm" id="nextPreviewBtn" onclick="changeBulkPreview(1)">Next</button>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="sendBulkMessages()"><i class="fas fa-paper-plane me-2"></i>Send Now</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Premium Notification Container -->
<div class="premium-notification-container" id="notificationContainer"></div>

<script>
  // API_BASE is already declared globally in main.hbs layout
  let allReminders = [];
  let currentFilter = 'all';
  let currentPage = 1;
  const itemsPerPage = 10;
  let selectedReminderIds = new Set();
  let allTemplates = [];
  let allEmailTemplates = [];
  let bulkValidReminders = [];
  let bulkPreviewIndex = 0;
  let currentTotalItems = 0;

  // Premium Notification System
  function showPremiumNotification({ type = 'info', title, message, stats = null, duration = 5000 }) {
    const container = document.getElementById('notificationContainer');
    if (!container) {
      alert(title + ': ' + message);
      return;
    }

    const notification = document.createElement('div');
    notification.className = `premium-notification ${type}${stats ? ' campaign-success-notification' : ''}`;
    
    const icons = {
      success: 'fa-check-circle',
      error: 'fa-exclamation-circle',
      warning: 'fa-exclamation-triangle',
      info: 'fa-info-circle'
    };

    let statsHTML = '';
    if (stats) {
      statsHTML = `
        <div class="notification-stats">
          <div class="notification-stat-item">
            <span class="notification-stat-label">Sent</span>
            <span class="notification-stat-value success">${stats.sent || 0}</span>
          </div>
          <div class="notification-stat-item">
            <span class="notification-stat-label">Failed</span>
            <span class="notification-stat-value ${stats.failed > 0 ? 'error' : ''}">${stats.failed || 0}</span>
          </div>
          ${stats.total ? `
          <div class="notification-stat-item">
            <span class="notification-stat-label">Total</span>
            <span class="notification-stat-value">${stats.total}</span>
          </div>
          ` : ''}
        </div>
      `;
    }

    notification.innerHTML = `
      <div class="notification-icon-wrapper">
        <i class="fas ${icons[type] || icons.info}"></i>
      </div>
      <div class="notification-content">
        <div class="notification-title">${escapeHtml(title || 'Notification')}</div>
        <div class="notification-message">${escapeHtml(message || '')}</div>
        ${statsHTML}
      </div>
      <button class="notification-close" onclick="this.parentElement.remove()">
        <i class="fas fa-times"></i>
      </button>
      <div class="notification-progress-bar"></div>
    `;

    container.appendChild(notification);

    // Auto remove after duration
    setTimeout(() => {
      notification.style.animation = 'slideInRight 0.3s ease-out reverse';
      setTimeout(() => notification.remove(), 300);
    }, duration);
  }

  function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadReminders();
  });

  async function loadReminders() {
    try {
      const response = await fetch(`${API_BASE}/reminders?days=30`, { 
        method: 'GET',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json'
        }
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        console.error('API Error Response:', errorData);
        throw new Error(errorData.message || `HTTP ${response.status}: Failed to load reminders`);
      }

      const result = await response.json();
      console.log('Reminders API Response:', result);
      
      // Handle ApiResponse format: { success: true, data: { reminders: [...] }, message: "..." }
      // or direct format: { reminders: [...] }
      if (result.data && result.data.reminders) {
        allReminders = result.data.reminders;
      } else if (Array.isArray(result.data)) {
        allReminders = result.data;
      } else if (Array.isArray(result.reminders)) {
        allReminders = result.reminders;
      } else if (Array.isArray(result)) {
        allReminders = result;
      } else {
        console.warn('Unexpected response format:', result);
        allReminders = [];
      }
      
      console.log('Parsed reminders:', allReminders.length, 'reminders');
      filterReminders(currentFilter, false);
    } catch (error) {
      console.error('Error loading reminders:', error);
      const container = document.getElementById('remindersList');
      if (container) {
        container.innerHTML = `
          <div class="text-center p-5">
            <i class="fas fa-exclamation-triangle text-danger fa-2x mb-3"></i>
            <p class="text-muted">Failed to load reminders. Please try again later.</p>
            <small class="text-muted">${error.message || ''}</small>
          </div>
        `;
      }
    }
  }

  function filterReminders(filter, clearSelection = true) {
    if (clearSelection && selectedReminderIds.size > 0 && currentFilter !== filter) {
      selectedReminderIds.clear();
    }
    currentFilter = filter;
    document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.toggle('active', tab.dataset.filter === filter));

    let filtered = allReminders;
    if (filter === 'today') filtered = allReminders.filter(r => r.isToday);
    else if (filter === 'birthday') filtered = allReminders.filter(r => r.type === 'birthday');
    else if (filter === 'anniversary') filtered = allReminders.filter(r => r.type === 'anniversary');
    else if (filter === 'upcoming') filtered = allReminders.filter(r => r.daysUntil > 0 && r.daysUntil <= 7);

    currentPage = 1;
    displayReminders(filtered);
  }

  function getPaginatedReminders(reminders) {
    const start = (currentPage - 1) * itemsPerPage;
    return reminders.slice(start, start + itemsPerPage);
  }

  function displayReminders(reminders) {
    const container = document.getElementById('remindersList');
    if (!container) return;

    if (!reminders.length) {
      container.innerHTML = `
        <div class="reminders-empty text-center p-5">
          <i class="fas fa-birthday-cake"></i>
          <h4>No reminders found</h4>
          <p>Add dates of birth and anniversaries to customers to see reminders here</p>
        </div>
      `;
      updatePaginationUI(0);
      updateBulkActionBar();
      return;
    }

    const paginated = getPaginatedReminders(reminders);
    const allSelected = paginated.length > 0 && paginated.every(r => selectedReminderIds.has(r.customerId));
    const someSelected = paginated.some(r => selectedReminderIds.has(r.customerId));

    const rows = paginated.map(reminder => {
      const dateStr = new Date(reminder.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: reminder.daysUntil > 365 ? 'numeric' : undefined });
      const daysText = reminder.isToday ? 'Today!' : (reminder.daysUntil === 1 ? 'Tomorrow' : `${reminder.daysUntil} days`);
      return `
        <tr data-customer-id="${reminder.customerId}">
          <td class="checkbox-col">
            <input type="checkbox" ${selectedReminderIds.has(reminder.customerId) ? 'checked' : ''} onchange="toggleReminderSelection(${reminder.customerId}, this.checked)">
          </td>
          <td>${escapeHtml(reminder.customerName)}</td>
          <td><span class="reminder-type-badge ${reminder.type}">${reminder.type === 'birthday' ? 'Birthday' : 'Anniversary'}</span></td>
          <td>${dateStr}</td>
          <td>${daysText}</td>
          <td class="reminder-actions">
            <button class="btn btn-sm btn-success" onclick="showSendWishModal(${reminder.customerId}, '${reminder.type}', 'whatsapp')" ${!reminder.phoneE164 ? 'disabled' : ''}><i class="fab fa-whatsapp"></i></button>
            <button class="btn btn-sm btn-primary" onclick="showSendWishModal(${reminder.customerId}, '${reminder.type}', 'email')" ${!reminder.email ? 'disabled' : ''}><i class="fas fa-envelope"></i></button>
            <button class="btn btn-sm btn-outline-secondary" onclick="showEditDateModal(${reminder.customerId})"><i class="fas fa-edit"></i></button>
          </td>
        </tr>
      `;
    }).join('');

    container.innerHTML = `
      <div class="table-responsive">
        <table class="reminders-table">
          <thead>
            <tr>
              <th class="checkbox-col">
                <input type="checkbox" id="selectAllCheckbox" ${allSelected ? 'checked' : ''} onchange="toggleSelectAll(this.checked)">
              </th>
              <th>Customer</th>
              <th>Type</th>
              <th>Date</th>
              <th>Days Until</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;

    const selectAll = document.getElementById('selectAllCheckbox');
    if (selectAll) selectAll.indeterminate = someSelected && !allSelected;
    updatePaginationUI(reminders.length);
    updateBulkActionBar();
  }

  function toggleReminderSelection(customerId, isSelected) {
    if (isSelected) selectedReminderIds.add(customerId);
    else selectedReminderIds.delete(customerId);
    updateBulkActionBar();
    updateSelectAllCheckbox();
  }

  function toggleSelectAll(selectAll) {
    document.querySelectorAll('#remindersList tbody tr').forEach(row => {
      const id = Number(row.getAttribute('data-customer-id'));
      const box = row.querySelector('input[type="checkbox"]');
      if (selectAll) {
        selectedReminderIds.add(id);
        box.checked = true;
      } else {
        selectedReminderIds.delete(id);
        box.checked = false;
      }
    });
    updateBulkActionBar();
    updateSelectAllCheckbox();
  }

  function updateSelectAllCheckbox() {
    const rows = Array.from(document.querySelectorAll('#remindersList tbody tr'));
    const selectAll = document.getElementById('selectAllCheckbox');
    if (!selectAll || !rows.length) return;
    const allSelected = rows.every(r => selectedReminderIds.has(Number(r.getAttribute('data-customer-id'))));
    const someSelected = rows.some(r => selectedReminderIds.has(Number(r.getAttribute('data-customer-id'))));
    selectAll.checked = allSelected;
    selectAll.indeterminate = someSelected && !allSelected;
  }

  function clearSelection() {
    selectedReminderIds.clear();
    document.querySelectorAll('#remindersList tbody input[type="checkbox"]').forEach(cb => cb.checked = false);
    updateBulkActionBar();
    updateSelectAllCheckbox();
  }

  function updateBulkActionBar() {
    const bar = document.getElementById('bulkActionBar');
    const countEl = document.getElementById('bulkSelectedCount');
    if (!bar || !countEl) return;
    const selected = Array.from(selectedReminderIds);
    if (!selected.length) {
      bar.style.display = 'none';
      return;
    }
    bar.style.display = 'flex';
    countEl.textContent = selected.length;
    const selectedReminders = allReminders.filter(r => selectedReminderIds.has(r.customerId));
    const hasWa = selectedReminders.some(r => r.phoneE164);
    const hasEmail = selectedReminders.some(r => r.email);
    document.getElementById('bulkWhatsAppBtn').disabled = !hasWa;
    document.getElementById('bulkEmailBtn').disabled = !hasEmail;
  }

  function changePage(delta) {
    const totalPages = Math.max(1, Math.ceil(currentTotalItems / itemsPerPage));
    currentPage = Math.min(Math.max(1, currentPage + delta), totalPages);
    filterReminders(currentFilter, false);
  }

  function goToPage(page) {
    const totalPages = Math.max(1, Math.ceil(currentTotalItems / itemsPerPage));
    currentPage = page === -1 ? totalPages : Math.min(Math.max(1, page), totalPages);
    filterReminders(currentFilter, false);
  }

  function updatePaginationUI(totalItems) {
    currentTotalItems = totalItems;
    const wrapper = document.getElementById('remindersPagination');
    if (!wrapper) return;
    const totalPages = Math.max(1, Math.ceil(totalItems / itemsPerPage));
    if (totalItems <= itemsPerPage) {
      wrapper.style.display = 'none';
      return;
    }
    wrapper.style.display = 'flex';
    document.getElementById('paginationInfo').textContent = `Page ${currentPage} of ${totalPages}`;
    document.getElementById('paginationTotal').textContent = `Showing ${Math.min(totalItems, itemsPerPage)} of ${totalItems}`;
    document.getElementById('firstPageBtn').disabled = currentPage === 1;
    document.getElementById('prevPageBtn').disabled = currentPage === 1;
    document.getElementById('nextPageBtn').disabled = currentPage === totalPages;
    document.getElementById('lastPageBtn').disabled = currentPage === totalPages;
  }

  // Edit date
  async function showEditDateModal(customerId) {
    try {
      const response = await fetch(`${API_BASE}/customers?pageSize=1000`, { credentials: 'include' });
      const result = await response.json();
      const customers = result.data?.customers || result.data || result.customers || [];
      const customer = customers.find(c => Number(c.id) === Number(customerId));
      if (customer) {
        document.getElementById('editCustomerId').value = customerId;
        document.getElementById('editDateOfBirth').value = customer.dateOfBirth || '';
        document.getElementById('editAnniversaryDate').value = customer.anniversaryDate || '';
        new bootstrap.Modal(document.getElementById('editDateModal')).show();
      }
    } catch (error) {
      console.error('Error loading customer:', error);
    }
  }

  async function saveDate() {
    const customerId = document.getElementById('editCustomerId').value;
    const dateOfBirth = document.getElementById('editDateOfBirth').value || null;
    const anniversaryDate = document.getElementById('editAnniversaryDate').value || null;
    try {
      const response = await fetch(`${API_BASE}/reminders/customer/${customerId}`, {
        method: 'PUT',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ dateOfBirth, anniversaryDate })
      });
      const result = await response.json();
      if (response.ok) {
        bootstrap.Modal.getInstance(document.getElementById('editDateModal')).hide();
        loadReminders();
      } else {
        alert(result.message || 'Failed to save date');
      }
    } catch (error) {
      console.error('Error saving date:', error);
      alert('Failed to save date. Please try again.');
    }
  }

  // Send wish modal
  async function showSendWishModal(customerId, type, channel) {
    document.getElementById('wishCustomerId').value = customerId;
    document.getElementById('wishType').value = type;
    document.getElementById('wishChannel').value = channel;
    document.getElementById('whatsappTemplateGroup').style.display = channel === 'whatsapp' ? 'block' : 'none';
    document.getElementById('emailTemplateGroup').style.display = channel === 'email' ? 'block' : 'none';
    document.getElementById('customMessageGroup').style.display = 'block';
    if (channel === 'whatsapp') await loadWhatsAppTemplates();
    if (channel === 'email') await loadEmailTemplates();
    new bootstrap.Modal(document.getElementById('sendWishModal')).show();
  }

  async function loadTemplates() {
    const channel = document.getElementById('wishChannel').value;
    document.getElementById('whatsappTemplateGroup').style.display = channel === 'whatsapp' ? 'block' : 'none';
    document.getElementById('emailTemplateGroup').style.display = channel === 'email' ? 'block' : 'none';
    document.getElementById('customMessageGroup').style.display = channel ? 'block' : 'none';
    if (channel === 'whatsapp') await loadWhatsAppTemplates();
    if (channel === 'email') await loadEmailTemplates();
  }

  async function loadWhatsAppTemplates() {
    try {
      const response = await fetch(`${API_BASE}/templates`, { credentials: 'include' });
      const result = await response.json();
      allTemplates = Array.isArray(result) ? result : (result.data || result.templates || []);
      const select = document.getElementById('whatsappTemplate');
      if (select) {
        select.innerHTML = '<option value="">Select Template (Optional)</option>';
        allTemplates.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t.id;
          opt.textContent = t.name || t.waName || 'Unnamed Template';
          select.appendChild(opt);
        });
      }
    } catch (error) {
      console.error('Error loading WhatsApp templates:', error);
    }
  }

  async function loadEmailTemplates() {
    try {
      const response = await fetch(`${API_BASE}/email-templates`, { 
        method: 'GET',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json'
        }
      });

      if (!response.ok) {
        console.error('Failed to load email templates:', response.status, response.statusText);
        const select = document.getElementById('emailTemplate');
        if (select) {
          select.innerHTML = '<option value="">No templates available</option>';
        }
        return;
      }

      const result = await response.json();
      console.log('Email templates API response:', result);
      
      let templates = [];
      if (Array.isArray(result)) {
        templates = result;
      } else if (result.data) {
        templates = Array.isArray(result.data) ? result.data : (result.data.emailTemplates || []);
      } else if (result.emailTemplates) {
        templates = result.emailTemplates;
      }
      
      // Filter out deleted templates
      templates = templates.filter(t => !t.deleted);
      
      allEmailTemplates = templates;
      const select = document.getElementById('emailTemplate');
      if (select) {
        select.innerHTML = '<option value="">Select Template (Optional)</option>';
        if (templates.length === 0) {
          select.innerHTML += '<option value="" disabled>No templates available</option>';
        } else {
          templates.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t.id;
            opt.textContent = t.templateName || t.name || t.subject || 'Unnamed Template';
            select.appendChild(opt);
          });
        }
      }
      console.log(`Loaded ${templates.length} email templates`);
    } catch (error) {
      console.error('Error loading email templates:', error);
      const select = document.getElementById('emailTemplate');
      if (select) {
        select.innerHTML = '<option value="">Error loading templates</option>';
      }
    }
  }

  async function sendWish() {
    const form = document.getElementById('sendWishForm');
    if (!form.checkValidity()) { form.reportValidity(); return; }
    
    const sendBtn = document.getElementById('sendWishBtn');
    const btnText = sendBtn.querySelector('.btn-text');
    const btnLoader = sendBtn.querySelector('.btn-loader');
    
    // Show loader and disable button
    sendBtn.disabled = true;
    btnText.style.display = 'none';
    btnLoader.style.display = 'inline-flex';
    sendBtn.style.opacity = '0.7';
    sendBtn.style.cursor = 'not-allowed';
    
    const payload = {
      customerId: parseInt(document.getElementById('wishCustomerId').value),
      type: document.getElementById('wishType').value,
      channel: document.getElementById('wishChannel').value,
      templateId: document.getElementById('whatsappTemplate').value || null,
      emailTemplateId: document.getElementById('emailTemplate').value || null,
      customMessage: document.getElementById('customMessage').value || null
    };
    
    try {
      const response = await fetch(`${API_BASE}/reminders/send-wish`, {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const result = await response.json();
      
      // Restore button state
      sendBtn.disabled = false;
      btnText.style.display = 'inline-flex';
      btnLoader.style.display = 'none';
      sendBtn.style.opacity = '1';
      sendBtn.style.cursor = 'pointer';
      
      if (response.ok) {
        bootstrap.Modal.getInstance(document.getElementById('sendWishModal')).hide();
        const channel = payload.channel === 'whatsapp' ? 'WhatsApp' : 'Email';
        showPremiumNotification({
          type: 'success',
          title: 'Wish Sent Successfully! ',
          message: `Your ${payload.type === 'birthday' ? 'birthday' : 'anniversary'} wish has been sent via ${channel}.`,
          duration: 5000
        });
        loadReminders();
      } else {
        showPremiumNotification({
          type: 'error',
          title: 'Failed to Send Wish',
          message: result.message || 'An error occurred while sending the wish. Please try again.',
          duration: 6000
        });
      }
    } catch (error) {
      console.error('Error sending wish:', error);
      
      // Restore button state on error
      sendBtn.disabled = false;
      btnText.style.display = 'inline-flex';
      btnLoader.style.display = 'none';
      sendBtn.style.opacity = '1';
      sendBtn.style.cursor = 'pointer';
      
      showPremiumNotification({
        type: 'error',
        title: 'Error',
        message: 'Failed to send wish. Please try again.',
        duration: 6000
      });
    }
  }

  // Bulk send
  async function openBulkSendModal(channel) {
    if (!selectedReminderIds.size) {
      alert('Select at least one customer');
      return;
    }
    const selected = allReminders.filter(r => selectedReminderIds.has(r.customerId));
    const valid = selected.filter(r => channel === 'whatsapp' ? r.phoneE164 : r.email);
    const skipped = selected.filter(r => channel === 'whatsapp' ? !r.phoneE164 : !r.email);
    if (!valid.length) {
      alert(`No valid ${channel === 'whatsapp' ? 'WhatsApp numbers' : 'emails'} in selection`);
      return;
    }

    bulkValidReminders = valid;
    bulkPreviewIndex = 0;
    document.getElementById('bulkChannel').value = channel;
    document.getElementById('bulkSummary').textContent = `${selected.length} selected`;
    document.getElementById('bulkCounts').textContent = `Sending to ${valid.length}, skipping ${skipped.length}`;
    document.getElementById('bulkSkippedList').textContent = skipped.length ? skipped.map(s => s.customerName).join(', ') : '';
    await loadBulkTemplates(channel);
    updateBulkPreview();
    document.getElementById('prevPreviewBtn').disabled = true;
    document.getElementById('nextPreviewBtn').disabled = valid.length <= 1;
    new bootstrap.Modal(document.getElementById('bulkSendModal')).show();
  }

  async function loadBulkTemplates(channel) {
    const select = document.getElementById('bulkTemplate');
    if (!select) return;
    select.innerHTML = '<option value="">No Template</option>';
    if (channel === 'whatsapp') {
      await loadWhatsAppTemplates();
      allTemplates.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.id;
        opt.textContent = t.name || t.waName || 'Unnamed Template';
        select.appendChild(opt);
      });
    } else {
      await loadEmailTemplates();
      allEmailTemplates.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.id;
        opt.textContent = t.templateName || t.name || t.subject || 'Unnamed Template';
        select.appendChild(opt);
      });
    }
  }

  function updateBulkPreview() {
    const previewEl = document.getElementById('bulkPreview');
    if (!bulkValidReminders.length) {
      previewEl.textContent = 'No valid recipients';
      return;
    }
    const reminder = bulkValidReminders[bulkPreviewIndex];
    let text = document.getElementById('bulkMessage').value || '';
    text = text.replace(/\{\{customer_name\}\}/gi, reminder.customerName || 'Customer')
               .replace(/\{\{customerName\}\}/gi, reminder.customerName || 'Customer')
               .replace(/\{\{company_name\}\}/gi, 'Company')
               .replace(/\{\{companyName\}\}/gi, 'Company');
    previewEl.textContent = text || 'Message preview';
    document.getElementById('previewCounter').textContent = `${bulkPreviewIndex + 1} / ${bulkValidReminders.length}`;
  }

  function changeBulkPreview(dir) {
    bulkPreviewIndex = Math.min(Math.max(0, bulkPreviewIndex + dir), bulkValidReminders.length - 1);
    updateBulkPreview();
    document.getElementById('prevPreviewBtn').disabled = bulkPreviewIndex === 0;
    document.getElementById('nextPreviewBtn').disabled = bulkPreviewIndex === bulkValidReminders.length - 1;
  }

  async function sendBulkMessages() {
    const channel = document.getElementById('bulkChannel').value;
    const message = document.getElementById('bulkMessage').value;
    const templateId = document.getElementById('bulkTemplate').value || null;
    if (!message && !templateId) {
      showPremiumNotification({
        type: 'warning',
        title: 'Message Required',
        message: 'Please enter a message or choose a template before sending.',
        duration: 4000
      });
      return;
    }
    const customerIds = Array.from(selectedReminderIds);
    try {
      const response = await fetch(`${API_BASE}/reminders/bulk-send`, {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          channel,
          customerIds,
          message,
          templateId: channel === 'whatsapp' ? templateId : null,
          emailTemplateId: channel === 'email' ? templateId : null,
          filter: currentFilter
        })
      });
      const result = await response.json();
      if (response.ok && result.success !== false) {
        bootstrap.Modal.getInstance(document.getElementById('bulkSendModal')).hide();
        const channelName = channel === 'whatsapp' ? 'WhatsApp' : 'Email';
        const stats = result.results || {};
        showPremiumNotification({
          type: stats.failed > 0 ? 'warning' : 'success',
          title: stats.failed > 0 ? 'Bulk Send Completed with Errors' : 'Bulk Send Completed! ',
          message: result.message || `Bulk send via ${channelName} has been completed.`,
          stats: {
            sent: stats.sent || 0,
            failed: stats.failed || 0,
            skipped: stats.skipped || 0,
            total: stats.total || customerIds.length
          },
          duration: 7000
        });
        clearSelection();
        loadReminders();
      } else {
        showPremiumNotification({
          type: 'error',
          title: 'Bulk Send Failed',
          message: result.message || 'Failed to start bulk send. Please try again.',
          duration: 6000
        });
      }
    } catch (error) {
      console.error('Error sending bulk messages', error);
      showPremiumNotification({
        type: 'error',
        title: 'Error',
        message: 'Failed to send bulk messages. Please try again.',
        duration: 6000
      });
    }
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
  }
</script>


