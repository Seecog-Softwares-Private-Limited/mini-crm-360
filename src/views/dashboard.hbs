<!-- dashboard.hbs -->

<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-3 col-lg-2 px-0">
      <div class="sidebar p-3">
        <div class="text-center mb-2">
          <h5 class="text-white">WhatsApp Manager</h5>
          <small class="text-white-50">{{user.firstName}} {{user.lastName}}</small>
        </div>

        <nav class="nav flex-column">
          <div class="menu-toggle" onclick="toggleMenu('whatsapp-submenu')">
            <div class="nav-link">
              <i class="fab fa-whatsapp"></i>
              WhatsApp
              <i class="fas fa-chevron-down float-end"></i>
            </div>
          </div>

          <div class="submenu show" id="whatsapp-submenu">
            <a class="nav-link active" href="/dashboard">
              <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
            <a class="nav-link" href="/business">
              <i class="fas fa-building"></i> Business
            </a>
            <a class="nav-link" href="/customers">
              <i class="fas fa-users"></i> Customers
            </a>
            <a class="nav-link" href="/templates">
              <i class="fas fa-file-alt"></i> Templates
            </a>
            <a class="nav-link" href="/campaigns">
              <i class="fas fa-bullhorn"></i> Campaigns
            </a>
          </div>

          <div class="menu-toggle" onclick="toggleMenu('hr-submenu')">
            <div class="nav-link">
              <i class="fas fa-users-cog"></i>
              HR Tools
              <i class="fas fa-chevron-down float-end"></i>
            </div>
          </div>

          <div class="submenu" id="hr-submenu">
            <a class="nav-link" href="/employees"><i class="fas fa-user-tie"></i> Employees</a>
            <a class="nav-link" href="/documents"><i class="fas fa-file-signature"></i> Documents</a>
          </div>

          <div class="menu-toggle mt-2" onclick="toggleMenu('utilities-submenu')">
            <div class="nav-link">
              <i class="fas fa-tools"></i>
              Utilities
              <i class="fas fa-chevron-down float-end"></i>
            </div>
          </div>

          <div class="submenu" id="utilities-submenu">
            <a class="nav-link" href="/document-types"><i class="fas fa-layer-group"></i> Document Types</a>
            <a class="nav-link" href="/email-templates"><i class="fas fa-envelope-open-text"></i> Email Templates</a>
          </div>

          <hr class="text-white-50" />

          <a class="nav-link" href="#" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Logout
          </a>
        </nav>
      </div>
    </div>

    <!-- Main Content -->
    <div class="col-md-9 col-lg-10">
      <div class="main-content p-4">

        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2>Dashboard</h2>
          {{!-- <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCustomerModal">
            <i class="fas fa-plus me-2"></i>Add Customer
          </button> --}}
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4">
          <div class="col-md-2 mb-3">
            <div class="card text-center h-100" style="cursor:pointer;"
              onclick="window.location.href='/business'">
              <div class="card-body">
                <i class="fas fa-building fa-2x text-primary mb-2"></i>
                <h5 class="card-title" id="countBusinesses">{{counts.businesses}}</h5>
                <p class="card-text text-muted">Businesses</p>
              </div>
            </div>
          </div>

          <div class="col-md-2 mb-3">
            <div class="card text-center h-100" style="cursor:pointer;"
              onclick="window.location.href='/customers'">
              <div class="card-body">
                <i class="fas fa-users fa-2x text-success mb-2"></i>
                <h5 class="card-title" id="countCustomers">{{counts.customers}}</h5>
                <p class="card-text text-muted">Customers</p>
              </div>
            </div>
          </div>

          <div class="col-md-2 mb-3">
            <div class="card text-center h-100" style="cursor:pointer;"
              onclick="window.location.href='/templates'">
              <div class="card-body">
                <i class="fas fa-file-alt fa-2x text-warning mb-2"></i>
                <h5 class="card-title" id="countTemplates">{{counts.templates}}</h5>
                <p class="card-text text-muted">Templates</p>
              </div>
            </div>
          </div>

          <div class="col-md-2 mb-3">
            <div class="card text-center h-100" style="cursor:pointer;"
              onclick="window.location.href='/campaigns'">
              <div class="card-body">
                <i class="fas fa-bullhorn fa-2x text-info mb-2"></i>
                <h5 class="card-title" id="countCampaigns">{{counts.campaigns}}</h5>
                <p class="card-text text-muted">Campaigns</p>
              </div>
            </div>
          </div>

          <div class="col-md-2 mb-3">
            <div class="card text-center h-100">
              <div class="card-body">
                <i class="fas fa-chart-line fa-2x text-secondary mb-2"></i>
                <h5 class="card-title" id="countMessages">{{counts.messages}}</h5>
                <p class="card-text text-muted">Messages Sent</p>
              </div>
            </div>
          </div>

          <div class="col-md-2 mb-3">
            <div class="card text-center h-100">
              <div class="card-body">
                <i class="fas fa-paper-plane fa-2x text-danger mb-2"></i>
                <h5 class="card-title" id="countSuccessRate">{{counts.successRate}}%</h5>
                <p class="card-text text-muted">Success Rate</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Customers -->
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Recent Customers</h5>
            <a href="/customers" class="btn btn-sm btn-outline-primary">View All</a>
          </div>

          <div class="card-body">
            <div id="customersList">
              <div class="text-muted">Loading...</div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Add Customer Modal -->
<div class="modal fade" id="addCustomerModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Add New Customer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <form id="addCustomerForm">
          <div class="mb-3">
            <label class="form-label">Name</label>
            <input type="text" class="form-control" name="name" required />
          </div>

          <div class="mb-3">
            <label class="form-label">Phone Number (E.164 format)</label>
            <div class="input-group">
              <span class="input-group-text">+91</span>
              <input type="tel" class="form-control" name="phoneE164" placeholder="9999999999" required />
            </div>
            <small class="form-text text-muted">Enter 10-digit mobile number without +91</small>
          </div>

          <div class="mb-3">
            <label class="form-label">Tags (comma separated)</label>
            <input type="text" class="form-control" name="tags" placeholder="vip, regular, premium" />
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="addCustomer()">Add Customer</button>
      </div>

    </div>
  </div>
</div>

<script>
  async function addCustomer() {
    const form = document.getElementById('addCustomerForm');
    const formData = new FormData(form);

    let phoneNumber = formData.get('phoneE164');
    if (phoneNumber && !phoneNumber.startsWith('+91')) {
      phoneNumber = '+91' + phoneNumber;
    }

    const customerData = {
      name: formData.get('name'),
      phoneE164: phoneNumber,
      tags: formData.get('tags')
        ? formData.get('tags').split(',').map(t => t.trim()).filter(Boolean)
        : [],
      consentAt: new Date().toISOString(),
    };

    try {
      const response = await fetch('/api/v1/customers', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(customerData),
      });

      const data = await response.json().catch(() => ({}));

      if (response.ok) {
        const modal = bootstrap.Modal.getInstance(document.getElementById('addCustomerModal'));
        modal.hide();
        form.reset();
        showAlert('Customer added successfully!', 'success');

        // refresh list + counts without full reload
        await loadRecentCustomers();
        await refreshCounts();

      } else {
        // if business missing
        if (data?.error?.toLowerCase()?.includes("create a business")) {
          showAlert('Please create a business first. Redirecting...', 'warning');
          setTimeout(() => window.location.href = '/business', 1200);
          return;
        }
        showAlert(data.error || 'Failed to add customer', 'danger');
      }
    } catch (err) {
      showAlert('Network error. Please try again.', 'danger');
    }
  }

  async function refreshCounts() {
    // If you don't have this API yet, you can keep the fallback reload
    try {
      const res = await fetch('/api/v1/dashboard/counts');
      if (!res.ok) return;

      const c = await res.json();
      if (document.getElementById('countBusinesses')) document.getElementById('countBusinesses').innerText = c.businesses ?? 0;
      if (document.getElementById('countCustomers')) document.getElementById('countCustomers').innerText = c.customers ?? 0;
      if (document.getElementById('countTemplates')) document.getElementById('countTemplates').innerText = c.templates ?? 0;
      if (document.getElementById('countCampaigns')) document.getElementById('countCampaigns').innerText = c.campaigns ?? 0;
    } catch (e) {
      // fallback (optional)
      // location.reload();
    }
  }

  async function loadRecentCustomers() {
    const el = document.getElementById('customersList');
    try {
      const res = await fetch('/api/v1/customers?limit=5');
      const rows = await res.json();

      if (!Array.isArray(rows) || rows.length === 0) {
        el.innerHTML = `<div class="text-muted">No customers yet.</div>`;
        return;
      }

      el.innerHTML = `
        <div class="table-responsive">
          <table class="table table-sm table-hover">
            <thead>
              <tr>
                <th>Name</th>
                <th>Phone</th>
                <th>Tags</th>
              </tr>
            </thead>
            <tbody>
              ${rows.map(r => `
                <tr>
                  <td>${escapeHtml(r.name || '-')}</td>
                  <td>${escapeHtml(r.phoneE164 || '-')}</td>
                  <td>${Array.isArray(r.tags) ? r.tags.map(t => `<span class="badge bg-light text-dark me-1">${escapeHtml(t)}</span>`).join('') : '-'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    } catch (e) {
      el.innerHTML = `<div class="text-danger">Failed to load customers</div>`;
    }
  }

  function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top:20px; right:20px; z-index:9999; min-width:320px;';
    alertDiv.innerHTML = `
      ${escapeHtml(message)}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);

    setTimeout(() => { alertDiv.remove(); }, 3500);
  }

  function escapeHtml(str) {
    return String(str)
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }

  // Load recent customers on page load
  document.addEventListener('DOMContentLoaded', () => {
    loadRecentCustomers();
  });
</script>
