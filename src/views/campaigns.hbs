<!-- Campaigns.hbs (Meta templates enabled) -->
<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    {{> sidebar}}

    <!-- Main Content -->
    <div class="col-md-9 col-lg-10">
      <div class="main-content p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2><i class="fas fa-bullhorn me-2"></i>Campaigns</h2>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createCampaignModal">
            <i class="fas fa-plus me-1"></i>Create Campaign
          </button>
        </div>

        <!-- Search and Filter -->
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-search"></i></span>
              <input type="text" class="form-control" id="searchCampaigns" placeholder="Search campaigns..." />
            </div>
          </div>
          <div class="col-md-3">
            <select class="form-select" id="statusFilter">
              <option value="">All Status</option>
              <option value="draft">Draft</option>
              <option value="scheduled">Scheduled</option>
              <option value="running">Running</option>
              <option value="completed">Completed</option>
              <option value="paused">Paused</option>
            </select>
          </div>
          <div class="col-md-3">
            <select class="form-select" id="businessFilter">
              <option value="">All Businesses</option>
            </select>
          </div>
          <div class="col-md-2">
            <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
              <i class="fas fa-times me-1"></i>Clear
            </button>
          </div>
        </div>

        <!-- Campaigns List -->
        <div class="card">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead class="table-light">
                  <tr>
                    <th>Name</th>
                    <th>Business</th>
                    <th>Template</th>
                    <th>Recipients</th>
                    <th>Status</th>
                    <th>Scheduled At</th>
                    <th>Created</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="campaignsTableBody">
                  <tr>
                    <td colspan="8" class="text-center py-4">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<style>
  /* ============================================
     PREMIUM CREATE CAMPAIGN MODAL STYLING
     ============================================ */
  
  .premium-campaign-modal .modal-dialog {
    max-width: 800px;
  }

  .premium-campaign-modal .modal-content {
    border-radius: 16px;
    border: none;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    overflow: hidden;
  }

  .premium-campaign-modal .modal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 16px 16px 0 0;
    padding: 1.75rem 2rem;
    border-bottom: none;
  }

  .premium-campaign-modal .modal-title {
    font-weight: 700;
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin: 0;
  }

  .premium-campaign-modal .modal-title i {
    font-size: 1.25rem;
  }

  .premium-campaign-modal .btn-close {
    filter: brightness(0) invert(1);
    opacity: 0.9;
    transition: opacity 0.2s ease;
  }

  .premium-campaign-modal .btn-close:hover {
    opacity: 1;
  }

  .premium-campaign-modal .modal-body {
    padding: 2rem;
    background: #ffffff;
  }

  .premium-campaign-modal .form-label {
    font-weight: 600;
    color: #475569;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .premium-campaign-modal .form-label i {
    color: #667eea;
    font-size: 0.875rem;
  }

  .premium-campaign-modal .form-label .text-danger {
    color: #ef4444;
    margin-left: 0.25rem;
  }

  .premium-campaign-modal .form-control,
  .premium-campaign-modal .form-select {
    border-radius: 10px;
    border: 2px solid rgba(226, 232, 240, 0.8);
    padding: 0.875rem 1rem;
    font-size: 0.95rem;
    transition: all 0.2s ease;
    background: #ffffff;
  }

  .premium-campaign-modal .form-control:focus,
  .premium-campaign-modal .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    outline: none;
  }

  .premium-campaign-modal .form-control::placeholder {
    color: #94a3b8;
  }

  .premium-campaign-modal textarea.form-control {
    resize: vertical;
    min-height: 100px;
  }

  .premium-campaign-modal .form-text {
    font-size: 0.8rem;
    color: #64748b;
    margin-top: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .premium-campaign-modal .form-text i {
    font-size: 0.75rem;
  }

  .premium-campaign-modal .modal-footer {
    border-top: 1px solid rgba(226, 232, 240, 0.8);
    padding: 1.5rem 2rem;
    background: #f8fafc;
  }

  .premium-campaign-modal .btn-secondary {
    background: #e2e8f0;
    border: none;
    color: #475569;
    font-weight: 600;
    padding: 0.75rem 1.5rem;
    border-radius: 10px;
    transition: all 0.2s ease;
  }

  .premium-campaign-modal .btn-secondary:hover {
    background: #cbd5e1;
    transform: translateY(-1px);
  }

  .premium-campaign-modal .btn-success {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    border: none;
    color: white;
    font-weight: 600;
    padding: 0.75rem 1.5rem;
    border-radius: 10px;
    transition: all 0.2s ease;
    box-shadow: 0 4px 6px rgba(16, 185, 129, 0.2);
  }

  .premium-campaign-modal .btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(16, 185, 129, 0.3);
    color: white;
  }

  .premium-campaign-modal .btn-success:active {
    transform: translateY(0);
  }

  /* Form Section Divider */
  .form-section {
    margin-bottom: 1.5rem;
  }

  .form-section-title {
    font-size: 0.875rem;
    font-weight: 700;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid rgba(226, 232, 240, 0.8);
  }

  /* Customer Selection Area */
  .customers-selection-area {
    border: 2px solid rgba(226, 232, 240, 0.8);
    border-radius: 12px;
    padding: 1rem;
    background: #f8fafc;
    max-height: 280px;
    overflow-y: auto;
    transition: all 0.2s ease;
  }

  .customers-selection-area:focus-within {
    border-color: #667eea;
    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
  }

  .customers-selection-area::-webkit-scrollbar {
    width: 6px;
  }

  .customers-selection-area::-webkit-scrollbar-track {
    background: rgba(226, 232, 240, 0.5);
    border-radius: 3px;
  }

  .customers-selection-area::-webkit-scrollbar-thumb {
    background: rgba(102, 126, 234, 0.3);
    border-radius: 3px;
  }

  .customers-selection-area::-webkit-scrollbar-thumb:hover {
    background: rgba(102, 126, 234, 0.5);
  }

  .select-all-checkbox {
    padding: 0.75rem;
    background: white;
    border-radius: 8px;
    margin-bottom: 0.75rem;
    border: 1px solid rgba(226, 232, 240, 0.8);
  }

  .select-all-checkbox .form-check-input {
    width: 1.25rem;
    height: 1.25rem;
    border-radius: 4px;
    border: 2px solid rgba(226, 232, 240, 0.8);
    cursor: pointer;
  }

  .select-all-checkbox .form-check-input:checked {
    background-color: #667eea;
    border-color: #667eea;
  }

  .select-all-checkbox .form-check-label {
    font-weight: 600;
    color: #475569;
    cursor: pointer;
    margin-left: 0.5rem;
  }

  .customer-checkbox-item {
    padding: 0.75rem;
    background: white;
    border-radius: 8px;
    margin-bottom: 0.5rem;
    border: 1px solid rgba(226, 232, 240, 0.8);
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .customer-checkbox-item:hover {
    background: rgba(102, 126, 234, 0.05);
    border-color: rgba(102, 126, 234, 0.3);
    transform: translateX(4px);
  }

  .customer-checkbox-item .form-check-input {
    width: 1.125rem;
    height: 1.125rem;
    border-radius: 4px;
    border: 2px solid rgba(226, 232, 240, 0.8);
    cursor: pointer;
    margin-top: 0.125rem;
  }

  .customer-checkbox-item .form-check-input:checked {
    background-color: #667eea;
    border-color: #667eea;
  }

  .customer-checkbox-item .form-check-label {
    flex: 1;
    cursor: pointer;
    color: #334155;
    font-size: 0.9rem;
  }

  .customer-checkbox-item .customer-phone {
    color: #64748b;
    font-size: 0.85rem;
  }

  /* Meta Template Badge */
  .meta-template-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    border-radius: 8px;
    font-size: 0.85rem;
    color: #475569;
    margin-top: 0.5rem;
  }

  .meta-template-badge i {
    color: #667eea;
  }

  /* Schedule Type Indicator */
  .schedule-type-indicator {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: rgba(16, 185, 129, 0.1);
    border-radius: 8px;
    font-size: 0.85rem;
    color: #059669;
    margin-top: 0.5rem;
  }

  .schedule-type-indicator.scheduled {
    background: rgba(59, 130, 246, 0.1);
    color: #2563eb;
  }

  /* Channel Type Indicator */
  .channel-type-indicator {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: rgba(37, 211, 102, 0.1);
    border-radius: 8px;
    font-size: 0.85rem;
    color: #059669;
    margin-top: 0.5rem;
  }

  .channel-type-indicator.email {
    background: rgba(59, 130, 246, 0.1);
    color: #2563eb;
  }

  /* Responsive */
  @media (max-width: 576px) {
    .premium-campaign-modal .modal-body {
      padding: 1.5rem;
    }

    .premium-campaign-modal .modal-header {
      padding: 1.25rem 1.5rem;
    }

    .premium-campaign-modal .modal-footer {
      padding: 1rem 1.5rem;
      flex-direction: column-reverse;
    }

    .premium-campaign-modal .btn-secondary,
    .premium-campaign-modal .btn-success {
      width: 100%;
      margin: 0.25rem 0;
    }
  }
</style>

<!-- Create Campaign Modal -->
<div class="modal fade premium-campaign-modal" id="createCampaignModal" tabindex="-1" aria-labelledby="createCampaignModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createCampaignModalLabel">
          <i class="fas fa-bullhorn"></i>
          Create New Campaign
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="createCampaignForm">
          <!-- Basic Information Section -->
          <div class="form-section">
            <div class="form-section-title">
              <i class="fas fa-info-circle me-2"></i>Basic Information
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="campaignName" class="form-label">
                  <i class="fas fa-tag"></i>
                  Campaign Name <span class="text-danger">*</span>
                </label>
                <input type="text" class="form-control" id="campaignName" placeholder="Summer Sale Campaign" required />
              </div>
              <div class="col-md-6 mb-3">
                <label for="campaignBusiness" class="form-label">
                  <i class="fas fa-building"></i>
                  Business <span class="text-danger">*</span>
                </label>
                <select class="form-select" id="campaignBusiness" required>
                  <option value="">Select Business</option>
                </select>
                <small class="form-text">
                  <i class="fas fa-info-circle"></i>
                  Select the business for this campaign
                </small>
              </div>
            </div>
          </div>

          <!-- Channel Selection Section -->
          <div class="form-section">
            <div class="form-section-title">
              <i class="fas fa-paper-plane me-2"></i>Channel Selection
            </div>
            <div class="mb-3">
              <label for="campaignChannel" class="form-label">
                <i class="fas fa-broadcast-tower"></i>
                Send Via <span class="text-danger">*</span>
              </label>
              <select class="form-select" id="campaignChannel" required onchange="onChannelTypeChange(this.value)">
                <option value="whatsapp">ðŸ“± WhatsApp</option>
                <option value="email">ðŸ“§ Email</option>
              </select>
              <div class="channel-type-indicator" id="channelIndicator">
                <i class="fab fa-whatsapp"></i>
                <span>Campaign will be sent via WhatsApp</span>
              </div>
            </div>
          </div>

          <!-- Template Selection Section -->
          <div class="form-section">
            <div class="form-section-title">
              <i class="fas fa-file-alt me-2"></i>Template Selection
            </div>
            <div class="mb-3" id="whatsappTemplateGroup">
              <label for="campaignTemplate" class="form-label">
                <i class="fab fa-meta"></i>
                Meta Template (WhatsApp) <span class="text-danger">*</span>
              </label>
              <select class="form-select" id="campaignTemplate" required title="Loaded from Meta">
                <option value="">Select Template from Meta</option>
              </select>
              <div class="meta-template-badge">
                <i class="fas fa-cloud-download-alt"></i>
                <span>Templates are fetched from your Meta account (Graph API)</span>
              </div>
            </div>
            <div class="mb-3" id="emailTemplateGroup" style="display:none;">
              <label for="campaignEmailTemplate" class="form-label">
                <i class="fas fa-envelope"></i>
                Email Template <span class="text-danger">*</span>
              </label>
              <select class="form-select" id="campaignEmailTemplate" title="Select Email Template">
                <option value="">Select Email Template</option>
              </select>
              <div class="meta-template-badge">
                <i class="fas fa-info-circle"></i>
                <span>Select an email template for this campaign</span>
              </div>
            </div>
          </div>

          <!-- Customer Selection Section -->
          <div class="form-section">
            <div class="form-section-title">
              <i class="fas fa-users me-2"></i>Customer Selection
            </div>
            <div class="mb-3">
              <label class="form-label">
                <i class="fas fa-user-check"></i>
                Select Customers <span class="text-danger">*</span>
              </label>
              <div class="customers-selection-area">
                <div class="select-all-checkbox">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="selectAllCustomers" />
                    <label class="form-check-label" for="selectAllCustomers">Select All Customers</label>
                  </div>
                </div>
                <div id="customersList">
                  <p class="text-muted text-center py-3">
                    <i class="fas fa-info-circle me-2"></i>
                    Please select a business first to load customers
                  </p>
                </div>
              </div>
              <small class="form-text">
                <i class="fas fa-lightbulb"></i>
                Select at least one customer to send the campaign to
              </small>
            </div>
          </div>

          <!-- Scheduling Section -->
          <div class="form-section">
            <div class="form-section-title">
              <i class="fas fa-clock me-2"></i>Scheduling
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="scheduleType" class="form-label">
                  <i class="fas fa-calendar-alt"></i>
                  Schedule Type <span class="text-danger">*</span>
                </label>
                <select class="form-select" id="scheduleType" onchange="onScheduleTypeChange(this.value)" required>
                  <option value="immediate">âš¡ Send Immediately</option>
                  <option value="scheduled">ðŸ“… Schedule for Later</option>
                </select>
                <div class="schedule-type-indicator" id="scheduleIndicator">
                  <i class="fas fa-bolt"></i>
                  <span>Campaign will be sent immediately</span>
                </div>
              </div>
              <div class="col-md-6 mb-3" id="scheduleDateTimeGroup" style="display:none;">
                <label for="scheduleDateTime" class="form-label">
                  <i class="fas fa-calendar-check"></i>
                  Schedule Date & Time <span class="text-danger">*</span>
                </label>
                <input type="datetime-local" class="form-control" id="scheduleDateTime" />
                <small class="form-text">
                  <i class="fas fa-info-circle"></i>
                  Select when to send this campaign
                </small>
              </div>
            </div>
          </div>

          <!-- Additional Information Section -->
          <div class="form-section">
            <div class="form-section-title">
              <i class="fas fa-align-left me-2"></i>Additional Information
            </div>
            <div class="mb-3">
              <label for="campaignDescription" class="form-label">
                <i class="fas fa-file-alt"></i>
                Campaign Description
              </label>
              <textarea class="form-control" id="campaignDescription" rows="3" placeholder="Optional description for this campaign (e.g., goals, target audience, etc.)"></textarea>
              <small class="form-text">
                <i class="fas fa-lightbulb"></i>
                Add notes or details about this campaign (optional)
              </small>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-2"></i>Cancel
        </button>
        <button type="button" class="btn btn-success" id="actionCampaignBtn" onclick="createAndSendCampaign()">
          <i class="fas fa-paper-plane me-2"></i>Send Now
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Campaign Modal -->
<div class="modal fade" id="editCampaignModal" tabindex="-1" aria-labelledby="editCampaignModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editCampaignModalLabel">Edit Campaign</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editCampaignForm">
          <input type="hidden" id="editCampaignId" />
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="editCampaignName" class="form-label">Campaign Name *</label>
              <input type="text" class="form-control" id="editCampaignName" required />
            </div>
            <div class="col-md-6 mb-3">
              <label for="editCampaignBusiness" class="form-label">Business *</label>
              <select class="form-select" id="editCampaignBusiness" required>
                <option value="">Select Business</option>
              </select>
            </div>
          </div>

          <!-- Edit also picks from Meta -->
          <div class="mb-3">
            <label for="editCampaignTemplate" class="form-label">Template (Meta) *</label>
            <select class="form-select" id="editCampaignTemplate" required>
              <option value="">Select Template from Meta</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Select Customers *</label>
            <div class="border rounded p-3" style="max-height: 220px; overflow-y: auto;">
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="editSelectAllCustomers" />
                <label class="form-check-label fw-bold" for="editSelectAllCustomers">Select All Customers</label>
              </div>
              <div id="editCustomersList"><p class="text-muted">Please select a business first</p></div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="editScheduleType" class="form-label">Schedule Type *</label>
              <select class="form-select" id="editScheduleType" required>
                <option value="immediate">Send Immediately</option>
                <option value="scheduled">Schedule for Later</option>
              </select>
            </div>
            <div class="col-md-6 mb-3" id="editScheduleDateTimeGroup" style="display:none;">
              <label for="editScheduleDateTime" class="form-label">Schedule Date & Time *</label>
              <input type="datetime-local" class="form-control" id="editScheduleDateTime" />
            </div>
          </div>

          <div class="mb-3">
            <label for="editCampaignDescription" class="form-label">Description</label>
            <textarea class="form-control" id="editCampaignDescription" rows="3" placeholder="Optional description for this campaign"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="updateCampaign()"><i class="fas fa-save me-1"></i>Update Campaign</button>
      </div>
    </div>
  </div>
</div>

<!-- Campaign Details Modal -->
<div class="modal fade" id="campaignDetailsModal" tabindex="-1" aria-labelledby="campaignDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="campaignDetailsModalLabel">Campaign Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="campaignDetailsContent"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Premium Notification Container -->
<div class="premium-notification-container" id="notificationContainer"></div>

<script>
  // ---- Premium Notification System ----
  function showPremiumNotification({ type = 'info', title, message, stats = null, duration = 5000 }) {
    const container = document.getElementById('notificationContainer');
    if (!container) {
      // Fallback to alert if container doesn't exist
      alert(title + ': ' + message);
      return;
    }

    const notification = document.createElement('div');
    notification.className = `premium-notification ${type}${stats ? ' campaign-success-notification' : ''}`;
    
    const icons = {
      success: 'fa-check-circle',
      error: 'fa-exclamation-circle',
      warning: 'fa-exclamation-triangle',
      info: 'fa-info-circle'
    };

    let statsHTML = '';
    if (stats) {
      statsHTML = `
        <div class="notification-stats">
          <div class="notification-stat-item">
            <span class="notification-stat-label">Sent</span>
            <span class="notification-stat-value success">${stats.sent || 0}</span>
          </div>
          <div class="notification-stat-item">
            <span class="notification-stat-label">Failed</span>
            <span class="notification-stat-value ${stats.failed > 0 ? 'error' : ''}">${stats.failed || 0}</span>
          </div>
          ${stats.total ? `
          <div class="notification-stat-item">
            <span class="notification-stat-label">Total</span>
            <span class="notification-stat-value">${stats.total}</span>
          </div>
          ` : ''}
        </div>
      `;
    }

    notification.innerHTML = `
      <div class="notification-icon-wrapper">
        <i class="fas ${icons[type] || icons.info}"></i>
      </div>
      <div class="notification-content">
        <div class="notification-title">${escapeHtml(title || 'Notification')}</div>
        <div class="notification-message">${escapeHtml(message || '')}</div>
        ${statsHTML}
      </div>
      <button class="notification-close" onclick="this.parentElement.remove()">
        <i class="fas fa-times"></i>
      </button>
      <div class="notification-progress-bar"></div>
    `;

    container.appendChild(notification);

    // Auto remove after duration
    setTimeout(() => {
      notification.style.animation = 'slideInRight 0.3s ease-out reverse';
      setTimeout(() => notification.remove(), 300);
    }, duration);
  }

  function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  // ---- state ----
  let campaigns = [];
  let businesses = [];
  let metaTemplates = [];
  let customers = [];

  // ---- helpers ----
  const getId = (obj) => (obj ? (obj.id ?? obj._id) : undefined);
  const coerceId = (v) => (typeof v === 'string' && /^\d+$/.test(v) ? Number(v) : v);

  async function unwrap(respOrJson) {
    if (!respOrJson) return null;
    if (typeof respOrJson.ok === 'boolean' && typeof respOrJson.json === 'function') {
      if (!respOrJson.ok) throw new Error(await respOrJson.text());
      return respOrJson.json();
    }
    return respOrJson;
  }

  function getBusinessName(businessId, campaignBusiness = null) {
    // First try to use the included business object from the campaign
    if (campaignBusiness && campaignBusiness.businessName) {
      return campaignBusiness.businessName;
    }
    // Fallback to businesses array
    const b = (businesses || []).find((x) => String(getId(x)) === String(businessId));
    return b ? (b.businessName || 'Business') : 'Unknown';
  }

  function getStatusColor(status) {
    const c = { draft:'secondary', scheduled:'warning', running:'primary', completed:'success', paused:'danger' };
    return c[status] || 'secondary';
  }

  // display name of template for a campaign row
  function getCampaignTemplateDisplay(c) {
    // Check channel type
    const channelType = c.channelType || 'whatsapp';
    
    if (channelType === 'email') {
      // Email template
      if (c.emailTemplate && c.emailTemplate.templateName) {
        return `${c.emailTemplate.templateName} (Email)`;
      }
      if (c.emailTemplateId) {
        return `Email Template #${c.emailTemplateId}`;
      }
      return 'â€”';
    } else {
      // WhatsApp template
      if (c.metaTemplateName) {
        return `${c.metaTemplateName} (${c.metaTemplateLanguage || 'en_US'})`;
      }
      // local fallback (shouldn't happen now, but safe)
      if (c.template && (c.template.displayName || c.template.waName)) {
        return `${c.template.displayName || c.template.waName} (${c.template.category || 'â€”'})`;
      }
      return 'â€”';
    }
  }

  // ---- data loading ----
  async function loadCampaigns() {
    try {
      campaigns = await unwrap(await apiCall('/campaigns')) || [];
      displayCampaigns(campaigns);
    } catch (e) {
      console.error('loadCampaigns', e);
      displayCampaigns([]);
    }
  }

  async function loadBusinesses() {
    try {
      businesses = await unwrap(await apiCall('/business')) || [];
      populateBusinessDropdowns();
    } catch (e) { console.error('loadBusinesses', e); }
  }

  // Load from Meta (NOT local)
  async function loadMetaTemplates() {
    try {
      const resp = await unwrap(await apiCall('/templates/meta'));
      const rows = (resp && (resp.data || resp.templates || resp.items)) || [];
      metaTemplates = normalizeMetaTemplates(rows);
      populateMetaTemplateDropdowns();
    } catch (e) {
      console.error('loadMetaTemplates', e);
      metaTemplates = [];
      populateMetaTemplateDropdowns();
    }
  }

  // Load Email Templates
  async function loadEmailTemplates() {
    try {
      const resp = await unwrap(await apiCall('/email-templates'));
      const templates = Array.isArray(resp) ? resp : (resp?.data || []);
      const select = document.getElementById('campaignEmailTemplate');
      if (select) {
        select.innerHTML = '<option value="">Select Email Template</option>' +
          templates.map(t => `<option value="${getId(t)}">${escapeHtml(t.templateName || t.name || 'Untitled')}</option>`).join('');
      }
    } catch (e) {
      console.error('loadEmailTemplates', e);
      const select = document.getElementById('campaignEmailTemplate');
      if (select) {
        select.innerHTML = '<option value="">Error loading email templates</option>';
      }
    }
  }

  function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function normalizeMetaTemplates(rows) {
    const arr = Array.isArray(rows) ? rows : (rows?.data || []);
    // You can filter ONLY APPROVED templates if you want:
    // return arr.filter(r => (r.status || r.approval_status) === 'APPROVED').map(...)
    return arr.map(r => ({
      id: r.id || r.name,
      name: r.name,
      language: r.language || 'en_US',
      category: (r.category || '').toLowerCase(),
      status: r.status || r.approval_status || 'â€”',
    }));
  }

  // ---- UI population ----
  function populateBusinessDropdowns() {
    const ids = ['campaignBusiness', 'editCampaignBusiness', 'businessFilter'];
    ids.forEach((id) => {
      const sel = document.getElementById(id);
      if (!sel) return;
      const first = id === 'businessFilter'
        ? '<option value="">All Businesses</option>'
        : '<option value="">Select Business</option>';
      sel.innerHTML = first + (businesses || [])
        .map(b => `<option value="${getId(b)}">${b.businessName || 'Untitled'}</option>`)
        .join('');
    });
  }

  function populateMetaTemplateDropdowns() {
    const ids = ['campaignTemplate', 'editCampaignTemplate'];
    const opts = (metaTemplates || []).map(t => {
      // pack the needed meta info in data-attrs
      return `<option value="${t.name}" data-lang="${t.language}" data-cat="${t.category}">
        ${t.name} (${t.language}) ${t.status ? '- ' + t.status : ''}
      </option>`;
    }).join('');

    ids.forEach(id => {
      const sel = document.getElementById(id);
      if (!sel) return;
      sel.innerHTML = '<option value="">Select Template from Meta</option>' + opts;
    });
  }

  async function loadCustomersForBusiness(businessId, containerId) {
    const container = document.getElementById(containerId);
    if (!businessId) {
      container.innerHTML = '<p class="text-muted">Please select a business first</p>';
      return;
    }
    try {
      const response = await unwrap(await apiCall(`/customers?businessId=${businessId}&pageSize=1000`));
      
      // Handle paginated response format
      let customerList = [];
      if (response && response.success && response.data) {
        customerList = response.data;
      } else if (Array.isArray(response)) {
        customerList = response;
      } else if (response && (response.data || response.items || response.customers)) {
        customerList = response.data || response.items || response.customers || [];
      }
      
      customers = customerList;
      displayCustomersForSelection(customers, containerId);
    } catch (e) {
      console.error('loadCustomersForBusiness', e);
      container.innerHTML = '<p class="text-muted text-danger"><i class="fas fa-exclamation-circle me-2"></i>Error loading customers. Please try again.</p>';
    }
  }

  function displayCustomersForSelection(list, containerId) {
    const container = document.getElementById(containerId);
    if (!list || list.length === 0) {
      container.innerHTML = '<p class="text-muted">No customers found for this business</p>';
      return;
    }
    container.innerHTML = list.map(c => {
      const id = getId(c);
      const inputId = `cb_${containerId}_${id}`;
      return `
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="${id}" id="${inputId}">
          <label class="form-check-label" for="${inputId}">
            ${c.name || 'No Name'} - ${c.phoneE164 || ''}
          </label>
        </div>`;
    }).join('');
  }

  function displayCampaigns(list) {
    const tbody = document.getElementById('campaignsTableBody');
    if (!list || list.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">No campaigns found</td></tr>';
      return;
    }
    tbody.innerHTML = list.map(c => {
      const id = getId(c);
      return `
        <tr>
          <td><div><strong>${c.name || 'Untitled'}</strong>${c.description ? `<br><small class="text-muted">${c.description}</small>` : ''}</div></td>
          <td>${getBusinessName(c.businessId, c.business)}</td>
          <td>${getCampaignTemplateDisplay(c)}</td>
          <td><span class="badge bg-info">${c.recipientCount || 0} recipients</span></td>
          <td><span class="badge bg-${getStatusColor(c.status)}">${c.status || 'draft'}</span></td>
          <td>${c.scheduledAt ? new Date(c.scheduledAt).toLocaleString() : 'Immediate'}</td>
          <td>${c.createdAt ? new Date(c.createdAt).toLocaleDateString() : 'â€”'}</td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" onclick="viewCampaign('${id}')" title="View"><i class="fas fa-eye"></i></button>
              <button class="btn btn-outline-warning" onclick="editCampaign('${id}')" title="Edit"><i class="fas fa-edit"></i></button>
              <button class="btn btn-outline-success" onclick="sendCampaign('${id}')" title="Send"><i class="fas fa-paper-plane"></i></button>
              <button class="btn btn-outline-danger" onclick="deleteCampaign('${id}')" title="Delete"><i class="fas fa-trash"></i></button>
            </div>
          </td>
        </tr>`;
    }).join('');
  }

  // ---- filters ----
  function filterCampaigns() {
    const q = document.getElementById('searchCampaigns').value.toLowerCase().trim();
    const status = document.getElementById('statusFilter').value;
    const biz = document.getElementById('businessFilter').value;

    const filtered = (campaigns || []).filter(c => {
      const matchesQ = (c.name || '').toLowerCase().includes(q) || (c.description || '').toLowerCase().includes(q);
      const matchesS = !status || c.status === status;
      const matchesB = !biz || String(c.businessId) === String(biz);
      return matchesQ && matchesS && matchesB;
    });
    displayCampaigns(filtered);
  }
  function clearFilters() {
    document.getElementById('searchCampaigns').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('businessFilter').value = '';
    displayCampaigns(campaigns);
  }

  // ---- CRUD helpers ----
  function collectSelected(containerId, selectAllId) {
    return Array.from(
      document.querySelectorAll(`#${containerId} input[type="checkbox"]:not(#${selectAllId}):checked`)
    ).map(cb => coerceId(cb.value));
  }

  function readSelectedMetaTemplate(selectId) {
    const sel = document.getElementById(selectId);
    const opt = sel?.selectedOptions?.[0];
    if (!opt || !opt.value) return null;
    return {
      name: opt.value,
      language: opt.dataset.lang || 'en_US',
      category: (opt.dataset.cat || '').toLowerCase()
    };
  }

  // ---- create / send ----
  async function createCampaign() {
    const form = document.getElementById('createCampaignForm');
    if (!form.checkValidity()) { form.reportValidity(); return; }

    const selected = collectSelected('customersList', 'selectAllCustomers');
    if (selected.length === 0) { 
      showPremiumNotification({
        type: 'warning',
        title: 'No Customers Selected',
        message: 'Please select at least one customer to send the campaign to.'
      });
      return; 
    }

    const channelType = document.getElementById('campaignChannel').value;
    let template = null;

    if (channelType === 'whatsapp') {
      template = readSelectedMetaTemplate('campaignTemplate');
      if (!template) { 
        showPremiumNotification({
          type: 'warning',
          title: 'Template Required',
          message: 'Please select a Meta template for WhatsApp campaigns.'
        });
        return; 
      }
    } else if (channelType === 'email') {
      const emailTemplateId = document.getElementById('campaignEmailTemplate').value;
      if (!emailTemplateId) { 
        showPremiumNotification({
          type: 'warning',
          title: 'Email Template Required',
          message: 'Please select an email template for email campaigns.'
        });
        return; 
      }
      template = { emailTemplateId: coerceId(emailTemplateId) };
    }

    const payload = {
      name: document.getElementById('campaignName').value,
      businessId: coerceId(document.getElementById('campaignBusiness').value),
      customerIds: selected,
      channelType: channelType,
      scheduleType: document.getElementById('scheduleType').value,
      scheduledAt: document.getElementById('scheduleType').value === 'scheduled'
        ? new Date(document.getElementById('scheduleDateTime').value).toISOString()
        : null,
      description: document.getElementById('campaignDescription').value,
      metaTemplate: channelType === 'whatsapp' ? template : null,
      emailTemplate: channelType === 'email' ? template : null
    };

    try {
      const created = await unwrap(await apiCall('/campaigns', { method: 'POST', body: JSON.stringify(payload) }));
      campaigns = [created, ...campaigns];
      displayCampaigns(campaigns);
      bootstrap.Modal.getInstance(document.getElementById('createCampaignModal'))?.hide();
      form.reset();
      showPremiumNotification({
        type: 'success',
        title: 'Campaign Created!',
        message: 'Your campaign has been successfully created.'
      });
      loadCampaigns();
    } catch (e) {
      showPremiumNotification({
        type: 'error',
        title: 'Campaign Error',
        message: 'Failed to create campaign: ' + e.message
      });
    }
  }

  async function createAndSendCampaign() {
    const form = document.getElementById('createCampaignForm');
    if (!form.checkValidity()) { form.reportValidity(); return; }
    const selected = collectSelected('customersList', 'selectAllCustomers');
    if (selected.length === 0) { 
      showPremiumNotification({
        type: 'warning',
        title: 'No Customers Selected',
        message: 'Please select at least one customer to send the campaign to.'
      });
      return; 
    }
    if (!confirm('Send this campaign to all selected customers now?')) return;

    const channelType = document.getElementById('campaignChannel').value;
    let template = null;

    if (channelType === 'whatsapp') {
      template = readSelectedMetaTemplate('campaignTemplate');
      if (!template) { 
        showPremiumNotification({
          type: 'warning',
          title: 'Template Required',
          message: 'Please select a Meta template for WhatsApp campaigns.'
        });
        return; 
      }
    } else if (channelType === 'email') {
      const emailTemplateId = document.getElementById('campaignEmailTemplate').value;
      if (!emailTemplateId) { 
        showPremiumNotification({
          type: 'warning',
          title: 'Email Template Required',
          message: 'Please select an email template for email campaigns.'
        });
        return; 
      }
      template = { emailTemplateId: coerceId(emailTemplateId) };
    }

    const payload = {
      name: document.getElementById('campaignName').value,
      businessId: coerceId(document.getElementById('campaignBusiness').value),
      customerIds: selected,
      channelType: channelType,
      scheduleType: 'immediate',
      description: document.getElementById('campaignDescription').value,
      metaTemplate: channelType === 'whatsapp' ? template : null,
      emailTemplate: channelType === 'email' ? template : null
    };

    try {
      const created = await unwrap(await apiCall('/campaigns', { method: 'POST', body: JSON.stringify(payload) }));
      const id = getId(created);
      const result = await unwrap(await apiCall(`/campaigns/${id}/send`, { method: 'POST' }));
      campaigns = [created, ...campaigns];
      displayCampaigns(campaigns);
      bootstrap.Modal.getInstance(document.getElementById('createCampaignModal'))?.hide();
      form.reset();
      showPremiumNotification({
        type: 'success',
        title: 'Campaign Created & Sent!',
        message: 'Your campaign has been successfully created and sent to all selected customers.',
        stats: {
          sent: result?.stats?.sent ?? 0,
          failed: result?.stats?.failed ?? 0,
          total: (result?.stats?.sent ?? 0) + (result?.stats?.failed ?? 0)
        }
      });
      loadCampaigns();
    } catch (e) {
      showPremiumNotification({
        type: 'error',
        title: 'Campaign Error',
        message: 'Failed to create or send campaign: ' + e.message
      });
    }
  }

  // ---- details / edit / update / delete / send ----
  async function viewCampaign(id) {
    try {
      const c = await unwrap(await apiCall(`/campaigns/${id}`));
      displayCampaignDetails(c);
      new bootstrap.Modal(document.getElementById('campaignDetailsModal')).show();
    } catch { 
      showPremiumNotification({
        type: 'error',
        title: 'Error',
        message: 'Failed to load campaign details.'
      });
    }
  }

  function displayCampaignDetails(c) {
    document.getElementById('campaignDetailsContent').innerHTML = `
      <div class="row">
        <div class="col-md-6">
          <h6>Campaign Information</h6>
          <p><strong>Name:</strong> ${c.name}</p>
          <p><strong>Description:</strong> ${c.description || 'N/A'}</p>
          <p><strong>Status:</strong> <span class="badge bg-${getStatusColor(c.status)}">${c.status}</span></p>
          <p><strong>Business:</strong> ${getBusinessName(c.businessId, c.business)}</p>
          <p><strong>Template:</strong> ${getCampaignTemplateDisplay(c)}</p>
        </div>
        <div class="col-md-6">
          <h6>Schedule Information</h6>
          <p><strong>Schedule Type:</strong> ${c.scheduleType || (c.scheduledAt ? 'scheduled' : 'immediate')}</p>
          <p><strong>Scheduled At:</strong> ${c.scheduledAt ? new Date(c.scheduledAt).toLocaleString() : 'Immediate'}</p>
          <p><strong>Created:</strong> ${c.createdAt ? new Date(c.createdAt).toLocaleString() : 'â€”'}</p>
          <p><strong>Recipients:</strong> ${c.recipientCount || 0}</p>
        </div>
      </div>`;
  }

  async function editCampaign(id) {
    try {
      const c = await unwrap(await apiCall(`/campaigns/${id}`));
      populateEditForm(c);
      new bootstrap.Modal(document.getElementById('editCampaignModal')).show();
    } catch { 
      showPremiumNotification({
        type: 'error',
        title: 'Error',
        message: 'Failed to load campaign for editing.'
      });
    }
  }

  function populateEditForm(c) {
    const id = getId(c);
    document.getElementById('editCampaignId').value = id;
    document.getElementById('editCampaignName').value = c.name || '';
    document.getElementById('editCampaignBusiness').value = c.businessId || '';
    document.getElementById('editCampaignDescription').value = c.description || '';

    // Set Meta template selection
    const sel = document.getElementById('editCampaignTemplate');
    if (c.metaTemplateName) {
      // find option by name + language (best effort)
      const opt = Array.from(sel.options).find(o => o.value === c.metaTemplateName && (o.dataset.lang || '') === (c.metaTemplateLanguage || 'en_US'));
      if (opt) sel.value = opt.value; // value is the name; language is in data-lang
    } else if (c.template) {
      // Backward compat: show local template in label only
      // (No local option shown in list; prefer Meta only)
    }

    // Schedule
    if (c.scheduledAt) {
      document.getElementById('editScheduleType').value = 'scheduled';
      document.getElementById('editScheduleDateTime').value = new Date(c.scheduledAt).toISOString().slice(0, 16);
      document.getElementById('editScheduleDateTimeGroup').style.display = 'block';
    } else {
      document.getElementById('editScheduleType').value = 'immediate';
      document.getElementById('editScheduleDateTimeGroup').style.display = 'none';
    }

    loadCustomersForBusiness(c.businessId, 'editCustomersList');
  }

  async function updateCampaign() {
    const form = document.getElementById('editCampaignForm');
    if (!form.checkValidity()) { form.reportValidity(); return; }

    const selected = collectSelected('editCustomersList', 'editSelectAllCustomers');
    if (selected.length === 0) { 
      showPremiumNotification({
        type: 'warning',
        title: 'No Customers Selected',
        message: 'Please select at least one customer to send the campaign to.'
      });
      return; 
    }

    const id = document.getElementById('editCampaignId').value;
    const metaTemplate = readSelectedMetaTemplate('editCampaignTemplate');
    if (!metaTemplate) { 
      showPremiumNotification({
        type: 'warning',
        title: 'Template Required',
        message: 'Please select a Meta template.'
      });
      return; 
    }

    const payload = {
      name: document.getElementById('editCampaignName').value,
      businessId: coerceId(document.getElementById('editCampaignBusiness').value),
      customerIds: selected,
      scheduleType: document.getElementById('editScheduleType').value,
      scheduledAt: document.getElementById('editScheduleType').value === 'scheduled'
        ? new Date(document.getElementById('editScheduleDateTime').value).toISOString()
        : null,
      description: document.getElementById('editCampaignDescription').value,
      metaTemplate
    };

    try {
      const data = await unwrap(await apiCall(`/campaigns/${id}`, { method: 'PUT', body: JSON.stringify(payload) }));
      campaigns = (campaigns || []).map(c => String(getId(c)) === String(id) ? data : c);
      displayCampaigns(campaigns);
      bootstrap.Modal.getInstance(document.getElementById('editCampaignModal'))?.hide();
      showPremiumNotification({
        type: 'success',
        title: 'Campaign Updated!',
        message: 'Your campaign has been successfully updated.'
      });
      loadCampaigns();
    } catch (e) {
      showPremiumNotification({
        type: 'error',
        title: 'Update Error',
        message: 'Failed to update campaign: ' + e.message
      });
    }
  }

  async function deleteCampaign(id) {
    if (!confirm('Are you sure you want to delete this campaign?')) return;
    try {
      const resp = await apiCall(`/campaigns/${id}`, { method: 'DELETE' });
      const ok = (typeof resp?.ok === 'boolean') ? resp.ok : true;
      if (!ok) throw new Error(await resp.text());
      campaigns = (campaigns || []).filter(c => String(getId(c)) !== String(id));
      displayCampaigns(campaigns);
      showPremiumNotification({
        type: 'success',
        title: 'Campaign Deleted!',
        message: 'The campaign has been successfully deleted.'
      });
    } catch (e) {
      showPremiumNotification({
        type: 'error',
        title: 'Delete Error',
        message: 'Failed to delete campaign: ' + e.message
      });
    }
  }

  async function sendCampaign(id) {
    if (!confirm('Send this campaign now?')) return;
    try {
      const result = await unwrap(await apiCall(`/campaigns/${id}/send`, { method: 'POST' }));
      showPremiumNotification({
        type: 'success',
        title: 'Campaign Sent!',
        message: 'Your campaign has been successfully sent to all selected customers.',
        stats: {
          sent: result?.stats?.sent ?? 0,
          failed: result?.stats?.failed ?? 0,
          total: (result?.stats?.sent ?? 0) + (result?.stats?.failed ?? 0)
        }
      });
      loadCampaigns();
    } catch (e) {
      showPremiumNotification({
        type: 'error',
        title: 'Send Error',
        message: 'Failed to send campaign: ' + e.message
      });
    }
  }

  // ---- events ----
  function setupEventListeners() {
    document.getElementById('searchCampaigns').addEventListener('input', filterCampaigns);
    document.getElementById('statusFilter').addEventListener('change', filterCampaigns);
    document.getElementById('businessFilter').addEventListener('change', filterCampaigns);

    document.getElementById('campaignBusiness').addEventListener('change', function () {
      document.getElementById('selectAllCustomers').checked = false;
      loadCustomersForBusiness(this.value, 'customersList');
    });

    document.getElementById('campaignChannel')?.addEventListener('change', function () {
      onChannelTypeChange(this.value);
    });
    document.getElementById('editCampaignBusiness').addEventListener('change', function () {
      document.getElementById('editSelectAllCustomers').checked = false;
      loadCustomersForBusiness(this.value, 'editCustomersList');
    });

    document.getElementById('scheduleType').addEventListener('change', function () {
      const g = document.getElementById('scheduleDateTimeGroup');
      if (this.value === 'scheduled') { g.style.display = 'block'; document.getElementById('scheduleDateTime').required = true; }
      else { g.style.display = 'none'; document.getElementById('scheduleDateTime').required = false; }
    });
    document.getElementById('editScheduleType').addEventListener('change', function () {
      const g = document.getElementById('editScheduleDateTimeGroup');
      if (this.value === 'scheduled') { g.style.display = 'block'; document.getElementById('editScheduleDateTime').required = true; }
      else { g.style.display = 'none'; document.getElementById('editScheduleDateTime').required = false; }
    });

    document.getElementById('selectAllCustomers').addEventListener('change', function () {
      document.querySelectorAll('#customersList input[type="checkbox"]').forEach(cb => cb.checked = this.checked);
    });
    document.getElementById('editSelectAllCustomers').addEventListener('change', function () {
      document.querySelectorAll('#editCustomersList input[type="checkbox"]').forEach(cb => cb.checked = this.checked);
    });

    document.getElementById('createCampaignModal').addEventListener('shown.bs.modal', () => {
      const val = document.getElementById('campaignBusiness').value;
      if (val) loadCustomersForBusiness(val, 'customersList');
      // Initialize channel type
      const channelType = document.getElementById('campaignChannel').value || 'whatsapp';
      onChannelTypeChange(channelType);
    });
    document.getElementById('editCampaignModal').addEventListener('shown.bs.modal', () => {
      const val = document.getElementById('editCampaignBusiness').value;
      if (val) loadCustomersForBusiness(val, 'editCustomersList');
    });
  }

  // ---- init ----
  document.addEventListener('DOMContentLoaded', function () {
    loadCampaigns();
    loadBusinesses();
    loadMetaTemplates();  // <- Meta templates!
    loadEmailTemplates(); // <- Email templates!
    setupEventListeners();
  });

  function onChannelTypeChange(value) {
    const whatsappGroup = document.getElementById('whatsappTemplateGroup');
    const emailGroup = document.getElementById('emailTemplateGroup');
    const whatsappTemplate = document.getElementById('campaignTemplate');
    const emailTemplate = document.getElementById('campaignEmailTemplate');
    const channelIndicator = document.getElementById('channelIndicator');

    if (value === 'whatsapp') {
      // Show WhatsApp template, hide email template
      if (whatsappGroup) whatsappGroup.style.display = 'block';
      if (emailGroup) emailGroup.style.display = 'none';
      if (whatsappTemplate) whatsappTemplate.required = true;
      if (emailTemplate) emailTemplate.required = false;

      // Update channel indicator
      if (channelIndicator) {
        channelIndicator.className = 'channel-type-indicator';
        channelIndicator.innerHTML = '<i class="fab fa-whatsapp"></i><span>Campaign will be sent via WhatsApp</span>';
      }
    } else if (value === 'email') {
      // Show email template, hide WhatsApp template
      if (whatsappGroup) whatsappGroup.style.display = 'none';
      if (emailGroup) emailGroup.style.display = 'block';
      if (whatsappTemplate) whatsappTemplate.required = false;
      if (emailTemplate) emailTemplate.required = true;

      // Update channel indicator
      if (channelIndicator) {
        channelIndicator.className = 'channel-type-indicator email';
        channelIndicator.innerHTML = '<i class="fas fa-envelope"></i><span>Campaign will be sent via Email</span>';
      }
    }
  }

  function onScheduleTypeChange(value) {
  const dateGroup = document.getElementById('scheduleDateTimeGroup');
  const dateInput = document.getElementById('scheduleDateTime');
  const actionBtn = document.getElementById('actionCampaignBtn');
  const scheduleIndicator = document.getElementById('scheduleIndicator');

  if (value === 'scheduled') {
    // show date & time
    dateGroup.style.display = 'block';
    dateInput.required = true;

    // Update schedule indicator
    if (scheduleIndicator) {
      scheduleIndicator.className = 'schedule-type-indicator scheduled';
      scheduleIndicator.innerHTML = '<i class="fas fa-calendar-check"></i><span>Campaign will be scheduled for later</span>';
    }

    // switch to Schedule
    actionBtn.innerHTML = '<i class="fas fa-clock me-1"></i>Schedule Now';
    actionBtn.onclick = createCampaign;
  } else {
    // hide date & time
    dateGroup.style.display = 'none';
    dateInput.required = false;
    dateInput.value = '';

    // Update schedule indicator
    if (scheduleIndicator) {
      scheduleIndicator.className = 'schedule-type-indicator';
      scheduleIndicator.innerHTML = '<i class="fas fa-bolt"></i><span>Campaign will be sent immediately</span>';
    }

    // switch to Send
    actionBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Send Now';
    actionBtn.onclick = createAndSendCampaign;
  }
}

</script>
